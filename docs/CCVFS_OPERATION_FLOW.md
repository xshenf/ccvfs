# CCVFS 压缩数据库操作流程图

## 插入操作流程

```
应用程序调用 SQLite API
          ↓
    SQLite 引擎处理 SQL
          ↓
    调用 VFS 写入接口
          ↓
   ┌─────────────────────┐
   │    CCVFS 拦截       │
   │   ccvfsIoWrite()    │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │  计算目标页编号      │
   │ page = offset/size │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │  读取现有页数据      │
   │ (如果页已存在)      │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │  修改页中的数据      │
   │  memcpy(新数据)     │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │   压缩整个页        │
   │  算法: RLE/LZ4/Zlib │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │   加密页数据        │
   │ (如果启用加密)      │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │  写入页头+数据      │
   │ 到物理文件位置      │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │   更新页索引        │
   │  保存到索引表       │
   └─────────────────────┘
          ↓
      操作完成
```

## 查询操作流程

```
应用程序调用 SQLite API
          ↓
    SQLite 引擎处理查询
          ↓
    调用 VFS 读取接口
          ↓
   ┌─────────────────────┐
   │    CCVFS 拦截       │
   │   ccvfsIoRead()     │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │  计算源页编号       │
   │ page = offset/size │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │   检查页缓存        │
   │  缓存命中?         │
   └─────────────────────┘
          ↓ (缓存未命中)
   ┌─────────────────────┐
   │ 根据索引找物理位置   │
   │  读取页头信息       │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │  读取压缩数据       │
   │  从物理文件        │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │   解密数据         │
   │ (如果启用加密)      │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │   解压缩数据        │
   │ 恢复原始页数据      │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │   验证校验和        │
   │  确保数据完整性     │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │ 提取请求的数据段     │
   │ 返回给应用程序      │
   └─────────────────────┘
          ↓
   ┌─────────────────────┐
   │  页加入缓存         │
   │ (供后续使用)       │
   └─────────────────────┘
          ↓
      查询完成
```

## 文件结构示意图

```
压缩数据库文件布局:
┌─────────────────┬──────────────┬──────────┬──────────┬─────┐
│   文件头 (128B)  │   页索引表    │  数据页1  │  数据页2  │ ... │
├─────────────────┼──────────────┼──────────┼──────────┼─────┤
│ 魔数,版本,算法   │ 每页位置大小  │ 头+压缩数据│ 头+压缩数据│     │
│ 页大小,文件大小  │ 偏移量信息   │          │          │     │
└─────────────────┴──────────────┴──────────┴──────────┴─────┘

每个数据页结构:
┌─────────────────┬─────────────────────────────────────────┐
│   页头 (24B)     │           压缩数据                       │
├─────────────────┼─────────────────────────────────────────┤
│ 魔数,序号,大小   │        zlib/lz4/rle 压缩的数据           │
│ 校验和,标志     │              可选加密                   │
└─────────────────┴─────────────────────────────────────────┘
```

## 性能优化策略

### 读取优化
```
顺序访问检测 → 预取下一页 → 减少I/O延迟
     ↓
页缓存策略 → LRU替换 → 提高命中率
     ↓
校验和验证 → 确保完整性 → 防止数据损坏
```

### 写入优化
```
事务批处理 → 内存缓存 → 减少磁盘写入
     ↓
写时复制 → 原子更新 → 保证一致性
     ↓
索引更新 → 延迟写入 → 提高性能
```

## 关键性能指标

| 操作类型 | 性能影响 | 优化策略 |
|---------|---------|---------|
| 随机读取 | +20-50% 延迟 | 页缓存,预取 |
| 顺序读取 | +10-20% 延迟 | 预取机制 |
| 随机写入 | +30-70% 延迟 | 事务批处理 |
| 批量写入 | +10-30% 延迟 | 内存缓存 |
| 空间占用 | -30-80% 大小 | 算法选择 |

## 错误处理机制

```
数据损坏检测
     ↓
┌─ 校验和错误 → 返回 SQLITE_CORRUPT
├─ 解压缩失败 → 尝试备份恢复
├─ 解密失败 → 检查密钥和算法
└─ 索引损坏 → 重建索引表
```

## 使用建议总结

### 页大小选择
- **4KB**: 适合 OLTP,随机访问频繁
- **64KB**: 默认推荐,平衡性能和压缩率  
- **1MB**: 适合数据仓库,最大压缩率

### 算法选择
- **RLE**: 极简数据,最快速度
- **LZ4**: 平衡性能,推荐 OLTP
- **Zlib**: 最佳压缩,适合存储优化

### 应用场景
- **实时系统**: 小页+LZ4+缓存
- **分析系统**: 大页+Zlib+预取
- **归档系统**: 最大页+最高压缩+加密